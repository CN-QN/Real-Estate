@{
    Layout = "~/Views/Shared/_LayoutAgent.cshtml";

}

<div class="container">
    <div class="fs-6 mb-2 fw-bold">Các bước đăng tin > <a class="text-decoration-none" href="#">Soạn tin đăng</a></div>
    <div class="bg-white p-4 mb-4">
        <p class="text-primary fw-bold">I. Thông tin cơ bản</p>
        <div class="row">
            <div class="col-6">
                <div class="  d-flex align-items-center justify-content-between   mb-4">
                    <div class="col-3 ">
                        <label class="form-label">
                            Tên dự án
                        </label>
                    </div>
                    <div class="col-9">
                        <input type="text" class="form-control" name="name" value="" placeholder="Nhập tên dự án" />
                    </div>
                </div>

                <div class="  d-flex align-items-center justify-content-between   mb-4">
                    <div class="col-3 ">
                        <label class="form-label">
                            Loại BĐS*
                        </label>
                    </div>
                    <div class="col-9">
                        <select class="form-select">
                            <option value="value">--Loại BĐS--</option>
                            <option value="value">text</option>
                            <option value="value">text</option>
                            <option value="value">text</option>
                            <option value="value">text</option>

                        </select>
                    </div>
                </div>
                <div class="  d-flex align-items-center justify-content-between   mb-4">
                    <div class="col-3 ">
                        <label class="form-label">
                            Tỉnh/Thành phố*
                        </label>
                    </div>
                    <div class="col-9">
                        <select id="provinceSelect" class="form-select">
                            <option value="value">-- Chọn Thành Phố --</option>
                            @foreach (var item in ViewBag.Provinces)

                            {
                                <option value="@item.code">@item.name</option>

                            }
                        </select>
                    </div>
                </div>
                <div class="  d-flex align-items-center justify-content-between   mb-4">
                    <div class="col-3 ">
                        <label class="form-label">
                            Quận/Huyện*
                        </label>
                    </div>
                    <div class="col-9">
                        <select id="districtSelect" class="form-select" disabled>
                            <option value="value">-- Chọn Quận/Huyện --</option>
                            @foreach (var item in ViewBag.Districts)

                            {
                                <option value="@item.code">@item.name</option>

                            }
                        </select>
                    </div>
                </div>
                <div class="  d-flex align-items-center justify-content-between   mb-4">
                    <div class="col-3 ">
                        <label class="form-label">
                            Xã/Phường
                        </label>
                    </div>
                    <div class="col-9">
                        <select id="wardSelect" class="form-select" disabled>
                            <option value="value">-- Chọn Xã/Phường --</option>
                            @foreach (var item in ViewBag.Wards)

                            {
                                <option value="@item.code">@item.name</option>

                            }
                        </select>
                    </div>
                </div>
                <div class="  d-flex align-items-center justify-content-between   mb-4">
                    <div class="col-3 ">
                        <label class="form-label">
                            Đường phố
                        </label>
                    </div>
                    <div class="col-9">
                        <input type="text" class="form-control" name="name" value="" placeholder="Nhập tên đường phố" />
                    </div>
                </div>
                <div class="  d-flex align-items-center justify-content-between   mb-4">
                    <div class="col-3 ">
                        <label class="form-label">
                            Địa chỉ
                        </label>
                    </div>
                    <div class="col-9">
                        <input type="text" class="form-control" placeholder="Nhập địa chỉ" name="name" value="" />
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div id="map" style="height: 450px; width: 100%; border-radius: 10px;"></div>
                <button id="btnCurrentLocation" type="button" class="btn btn-sm btn-outline-primary mt-2">
                    📍 Lấy vị trí hiện tại của tôi
                </button>
                <input type="hidden" id="latitude" name="latitude" />
                <input type="hidden" id="longitude" name="longitude" />
            </div>

        </div>


    </div>
    <div class="bg-white p-4 mb-4">
        <p class="text-primary fw-bold">
            II. Thông tin mô tả
        </p>
        <div class="row">
            <div class="col-6">
                <div class="  d-flex align-items-center justify-content-between   mb-4">
                    <div class="col-3 ">
                        <label class="form-label">
                            Giá tiền (VNĐ)*
                        </label>
                    </div>
                    <div class="col-9 d-flex justify-content-between ">
                        <div class="col-5">
                            <input type="text" class="form-control" name="name" value="" placeholder="Giá Min" />
                        </div>
                        <div class="col-5">
                            <input type="text" class="form-control" name="name" value="" placeholder="Giá Max" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="  d-flex align-items-center justify-content-between   mb-4">
                    <div class="col-3 ">
                        <label class="form-label">
                            Diện tích (m2)*
                        </label>
                    </div>
                    <div class="col-9 d-flex justify-content-between ">
                        <div class="col-5">
                            <input type="text" class="form-control" name="name" value="" placeholder="Giá Min" />
                        </div>
                        <div class="col-5">
                            <input type="text" class="form-control" name="name" value="" placeholder="Giá Max" />
                        </div>
                    </div>


                </div>

            </div>





        </div>

        <div class="  d-flex   justify-content-between   mb-4">
            <div class="col-1" style="margin-right:50px">
                <label class="form-label">
                    Mô tả*
                </label>
            </div>

            <div class="w-100 h-50">
                <textarea id="editor1" name="editorContent">@ViewBag.Content</textarea>


                <br />

            </div>

        </div>



    </div>
    <!-- ============================ -->
    <!-- III. Thông tin hình ảnh -->
    <!-- ============================ -->
    <div class="bg-white p-4 mb-4">
        <p class="text-primary fw-bold">
            III. Thông tin hình ảnh
        </p>

        <div class="mb-3">
            <label class="form-label">
                * Up ít nhất 3 ảnh cho bài đăng để đạt hiệu quả tốt hơn
            </label>
        </div>

        <div id="dropZone" class="border p-4 text-center rounded mb-2" style="min-height: 200px;">
            <p class="text-secondary mb-3">
                Tin đăng có hình ảnh thường hiệu quả hơn 59% tin đăng không có hình ảnh.
                <br />
                (Kéo thả tối đa 3 ảnh vào đây hoặc nhấn nút để tải lên)
            </p>
            <input id="imageInput"
                   type="file"
                   accept="image/*"
                   multiple
                   hidden
                   onchange="previewImages(event)" />

            <button type="button"
                    class="btn btn-outline-primary px-4"
                    onclick="document.getElementById('imageInput').click()">
                THÊM ẢNH
            </button>
        </div>

        <div id="imagePreviewContainer" class="d-flex flex-wrap mt-3">
        </div>

        <p class="text-danger small mt-2">
            * Lưu ý: Ảnh tải lên không được là ảnh sao chép trên Internet, không chứa logo, thông tin của website khác,
            kích thước ảnh tối thiểu 300 x 300px
        </p>
    </div>

    <div class="bg-white p-4 mb-4">
        <p class="text-primary fw-bold">
            IV. Chọn gói tin - Thanh toán
        </p>

        <div class="mb-3">
            <label class="form-label">
                * Quý khách nên chọn đăng tin VIP để có hiệu quả hơn.
                <br />
                VD: Tin <span class="text-danger fw-bold">HDY Diamond</span> có lượt xem trung bình
                <span class="text-danger fw-bold">cao hơn 20 lần</span> so với tin thường.
            </label>
        </div>

        <div class="row g-3 align-items-center mb-3">
            <div class="col-md-3">
                <label class="form-label fw-semibold">Loại tin</label>
                <select class="form-select">
                    <option selected>HDY Basic</option>
                    <option>HDY Silver</option>
                    <option>HDY Diamond</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-semibold">Thời gian</label>
                <select class="form-select">
                    <option selected>4 tuần</option>
                    <option>8 tuần</option>
                    <option>12 tuần</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-semibold">Ngày bắt đầu</label>
                <input type="date" class="form-control" value="2025-10-22" />
            </div>

            <div class="col-md-3">
                <label class="form-label fw-semibold">Ngày kết thúc</label>
                <input type="date" class="form-control" value="2025-11-19" readonly />
            </div>
        </div>

        <hr>

        <p class="fw-bold text-uppercase text-secondary mb-2">
            Giá trị tin đăng:
            <span class="text-primary">0 VNĐ</span>
        </p>

        <p class="fw-bold mb-2">Thanh toán bằng coupon:</p>

        <div class="table-responsive">
            <table class="table table-bordered align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <th>CHỌN MÃ</th>
                        <th>TÊN</th>
                        <th>MÃ COUPON</th>
                        <th>HẠN DÙNG</th>
                        <th>TÌNH TRẠNG</th>
                        <th>SỐ LẦN SỬ DỤNG</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="radio" name="coupon" /></td>
                        <td>[TK mới] Coupon Tin đăng HDY Basic 4 tuần</td>
                        <td>D1STLFH93M</td>
                        <td>28/11/2025</td>
                        <td class="text-success">Hoạt động</td>
                        <td>0/1</td>
                    </tr>
                    <tr>
                        <td><input type="radio" name="coupon" /></td>
                        <td>[TK mới] Coupon Tin đăng HDY Basic 4 tuần</td>
                        <td>MK0CAC8JZH</td>
                        <td>28/11/2025</td>
                        <td class="text-success">Hoạt động</td>
                        <td>0/1</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="d-flex justify-content-center mt-3">
        <button class="btn btn-primary me-2">Đăng tin</button>
        <button class="btn btn-outline-primary">Lưu nháp</button>

    </div>
</div>
@section scripts {
    <script src="https://cdn.tiny.cloud/1/kx77sij2dvxtzmlriaqeroor4p6s6t2k96kubu8bjs7d6zbp/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        tinymce.init({
            selector: 'textarea',
            plugins: [
                // Core editing features
                'anchor', 'autolink', 'charmap', 'codesample', 'emoticons', 'link', 'lists', 'media', 'searchreplace', 'table', 'visualblocks', 'wordcount',
                // Your account includes a free trial of TinyMCE premium features
                // Try the most popular premium features until Nov 14, 2025:
                'checklist', 'mediaembed', 'casechange', 'formatpainter', 'pageembed', 'a11ychecker', 'tinymcespellchecker', 'permanentpen', 'powerpaste', 'advtable', 'advcode', 'advtemplate', 'ai', 'uploadcare', 'mentions', 'tinycomments', 'tableofcontents', 'footnotes', 'mergetags', 'autocorrect', 'typography', 'inlinecss', 'markdown', 'importword', 'exportword', 'exportpdf'
            ],
            toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link media table mergetags | addcomment showcomments | spellcheckdialog a11ycheck typography uploadcare | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat',
            tinycomments_mode: 'embedded',
            tinycomments_author: 'Author name',
            mergetags_list: [
                { value: 'First.Name', title: 'First Name' },
                { value: 'Email', title: 'Email' },
            ],
            ai_request: (request, respondWith) => respondWith.string(() => Promise.reject('See docs to implement AI Assistant')),
            uploadcare_public_key: '97d038c425905e6e43e4',
        });
    </script>

    <script>

        $(document).ready(function () {
            const map = L.map('map').setView([10.762622, 106.660172], 13); // Mặc định HCM
            let marker = L.marker([10.762622, 106.660172]).addTo(map);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
            }).addTo(map);

            function setMarker(lat, lng, zoom = 14) {
                if (marker) marker.setLatLng([lat, lng]);
                else marker = L.marker([lat, lng]).addTo(map);
                map.setView([lat, lng], zoom);
                $('#latitude').val(lat);
                $('#longitude').val(lng);
            }

            map.on('click', function (e) {
                setMarker(e.latlng.lat, e.latlng.lng);
            });

            $('#btnCurrentLocation').click(function () {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function (pos) {
                            setMarker(pos.coords.latitude, pos.coords.longitude);
                        },
                        function (err) {
                            alert('Không thể lấy vị trí hiện tại: ' + err.message);
                        }
                    );
                } else {
                    alert('Trình duyệt không hỗ trợ định vị.');
                }
            });

            function searchLocation(address) {
                if (!address || address.trim() === '') return;

                $.ajax({
                    url: 'https://nominatim.openstreetmap.org/search',
                    data: {
                        format: 'json',
                        limit: 1,
                        q: address
                    },
                    headers: {
                        'Accept-Language': 'vi',
                        'User-Agent': 'RealEstateApp/1.0 (your-email@example.com)'
                    },
                    success: function (data) {
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lon = parseFloat(data[0].lon);
                            setMarker(lat, lon);
                        }
                    },
                    error: function () {
                        console.warn('Không thể truy vấn vị trí cho địa chỉ:', address);
                    }
                });
            }

            $('input[placeholder="Nhập địa chỉ"]').on('blur', function () {
                const fullAddress = $(this).val();
                if (fullAddress.trim() !== '') searchLocation(fullAddress);
            });
            $('#provinceSelect, #districtSelect, #wardSelect').change(function () {
                const provinceText = $('#provinceSelect option:selected').text();
                const districtText = $('#districtSelect option:selected').text();
                const wardText = $('#wardSelect option:selected').text();

                const fullAddress = [wardText, districtText, provinceText]
                    .filter(x => x && x !== "Nhập tên Thành Phố" && x !== "Nhập tên Quận/Huyện" && x !== "Nhập tên Xã/Phường")
                    .join(', ');

                console.log("fullAddress", fullAddress)
                if (fullAddress) searchLocation(fullAddress);

            });

            // === LOAD HUYỆN / XÃ THEO AJAX ===
            $('#provinceSelect').change(function () {
                const provinceCode = $(this).val();
                $('#districtSelect').html('<option value="">-- Chọn Quận/Huyện --</option>');
                if (provinceCode) {
                    $.getJSON('/Agent/Districts', { provinceCode: provinceCode }, function (data) {
                        $.each(data, function (i, item) {
                            $('#districtSelect').append($('<option>', {
                                value: item.code,
                                text: item.name
                            }));
                        });
                    });
                    $('#districtSelect').attr('disabled', false);

                }

            });

            $('#districtSelect').change(function () {
                const districtCode = $(this).val();
                $('#wardSelect').html('<option value="">-- Chọn Xã/Phường --</option>');
                if (districtCode) {
                    $.getJSON('/Agent/Wards', { districtCode: districtCode }, function (data) {
                        $.each(data, function (i, item) {
                            $('#wardSelect').append($('<option>', {
                                value: item.code,
                                text: item.name
                            }));
                        });
                    });
                    $('#wardSelect').attr('disabled', false);

                }
            });

        });

    </script>




    <script>

        // 💡 Hàm mới: Tải ảnh lên Cloudinary và trả về danh sách URL
        async function uploadImagesToCloudinaryAndGetUrls(files) {
            const cloudName = "djt5vwtjm"; // <-- THAY THẾ bằng Cloud Name của bạn
            const uploadPreset = "Real-Estate"; // <-- THAY THẾ bằng Upload Preset của bạn

            const uploadedUrls = [];
            const uploadPromises = [];

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', uploadPreset);

                const uploadPromise = fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.secure_url) {
                            uploadedUrls.push(data.secure_url);
                            return data.secure_url;
                        } else {
                            console.error('Lỗi upload ảnh:', data);
                            return null;
                        }
                    })
                    .catch(error => {
                        console.error('Lỗi mạng khi upload ảnh:', error);
                        return null;
                    });

                uploadPromises.push(uploadPromise);
            }

            await Promise.all(uploadPromises);
            return uploadedUrls;
        }


        // 💡 Hàm mới: Hiển thị ảnh preview và Tải lên Cloudinary
        let filesToUpload = []; // Lưu trữ các file đã chọn

        function previewImages(event) {
            filesToUpload = Array.from(event.target.files);
            const previewContainer = document.getElementById('imagePreviewContainer');
            if (!previewContainer) return; // Đảm bảo container tồn tại

            previewContainer.innerHTML = ''; // Xóa preview cũ

            if (filesToUpload.length > 7) {
                alert('Chỉ có thể tải lên tối đa 7 ảnh.');
                filesToUpload = filesToUpload.slice(0, 7);
            }

            filesToUpload.forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'image-preview-item me-2 mb-2 position-relative';
                    imgDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px;">
                    `;
                    previewContainer.appendChild(imgDiv);
                }
                reader.readAsDataURL(file);
            });

            // Cập nhật giao diện tải ảnh:
            const dropZone = document.getElementById('dropZone');
            if (dropZone) {
                dropZone.innerHTML = `
                    <p class="text-secondary mb-3">
                        Tin đăng có hình ảnh thường hiệu quả hơn 59% tin đăng không có hình ảnh.
                        <br/>
                        Đã chọn **${filesToUpload.length}** ảnh. (Tối thiểu 3 ảnh)
                    </p>
                    <button type="button"
                         class="btn btn-outline-primary px-4"
                         onclick="document.getElementById('imageInput').click()">
                         CHỌN LẠI ẢNH
                    </button>
                `;
            }
        }


        // 💡 Hàm mới: Xử lý sự kiện khi nhấn nút "Đăng tin"
        $('.btn-primary:contains("Đăng tin")').click(async function (e) {
            e.preventDefault(); // Ngăn chặn submit form mặc định
            $(this).attr('disabled', true).text('Đang tải...'); // Vô hiệu hóa nút

            try {
                // 1. Tải ảnh lên Cloudinary
                const imageUrls = await uploadImagesToCloudinaryAndGetUrls(filesToUpload);

                if (filesToUpload.length > 0 && imageUrls.length === 0) {
                    alert('Có lỗi xảy ra trong quá trình tải ảnh. Vui lòng thử lại.');
                    return;
                }

                // 2. Chuẩn bị dữ liệu form để gửi lên server
                const formData = {
                    TenDuAn: $('input[name="name"][placeholder="Nhập tên dự án"]').val(),
                    LoaiBDS: $('#propertyTypeSelect').val(), // Giả sử bạn thêm ID cho select này
                    ... // Thêm các trường dữ liệu khác ở đây
                    MoTa: tinymce.get("editor1").getContent(),
                    GiaMin: $('input[placeholder="Giá Min"]').eq(0).val(),
                    GiaMax: $('input[placeholder="Giá Max"]').eq(1).val(),
                    DienTichMin: $('input[placeholder="Giá Min"]').eq(2).val(),
                    DienTichMax: $('input[placeholder="Giá Max"]').eq(3).val(),

                    // Gắn các URL ảnh vào dữ liệu gửi lên DB
                    ImageUrls: imageUrls
                };

                console.log('Dữ liệu gửi lên server:', formData);


                // 3. Gửi dữ liệu đã có URL ảnh về Server (Controller) để lưu vào DB
                /*
                const response = await fetch('/Agent/PostNews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    alert('Đăng tin thành công!');
                    // Chuyển hướng hoặc hành động sau khi thành công
                } else {
                    alert('Lỗi khi lưu tin đăng vào DB.');
                }
                */

                alert('Quá trình upload ảnh và chuẩn bị dữ liệu hoàn tất. Dữ liệu đã sẵn sàng để gửi lên DB.');

            } catch (error) {
                console.error('Lỗi tổng thể:', error);
                alert('Đã xảy ra lỗi không mong muốn.');
            } finally {
                $(this).attr('disabled', false).text('Đăng tin'); // Bật lại nút
            }

        });

        // ... (Code Map và AJAX load địa lý)
        $('.btn-primary:contains("Đăng tin")').click(async function (e) {
            e.preventDefault();
            $(this).attr('disabled', true).text('Đang tải...');

            // Thu thập các giá trị từ form
            const tenDuAn = $('input[placeholder="Nhập tên dự án"]').val();
            const loaiBDS = $('#propertyTypeSelect').val(); // Cần đảm bảo select này có ID: 'propertyTypeSelect'
            const giaMin = $('input[placeholder="Giá Min"]').eq(0).val();
            const giaMax = $('input[placeholder="Giá Max"]').eq(1).val();
            const dienTichMin = $('input[placeholder="Giá Min"]').eq(2).val();
            const dienTichMax = $('input[placeholder="Giá Max"]').eq(3).val();
            const moTa = tinymce.get("editor1").getContent();

            const provinceCode = $('#provinceSelect').val();
            const districtCode = $('#districtSelect').val();
            const wardCode = $('#wardSelect').val() || null;
            const streetName = $('input[placeholder="Nhập tên đường phố"]').val();
            const addressDetail = $('input[placeholder="Nhập địa chỉ"]').val();
            const latitude = $('#latitude').val();
            const longitude = $('#longitude').val();

            // Lấy thông tin gói tin
            const thoiGianTuan = parseInt($('div.col-md-3:eq(1) select').val().replace(' tuần', '')); // 4/8/12
            const ngayBatDau = $('div.col-md-3:eq(2) input[type="date"]').val();

            try {
                // 1. Tải ảnh lên Cloudinary
                const imageUrls = await uploadImagesToCloudinaryAndGetUrls(filesToUpload);

                if (filesToUpload.length > 0 && imageUrls.length === 0) {
                    alert('Có lỗi xảy ra trong quá trình tải ảnh. Vui lòng thử lại.');
                    return;
                }

                // 2. Chuẩn bị dữ liệu DTO để gửi lên Server
                const formData = {
                    TenDuAn: tenDuAn,
                    LoaiBDS: parseInt(loaiBDS),
                    GiaMin: parseFloat(giaMin || 0),
                    GiaMax: parseFloat(giaMax || 0),
                    DienTichMin: parseFloat(dienTichMin || 0),
                    DienTichMax: parseFloat(dienTichMax || 0),
                    MoTa: moTa,

                    ProvinceCode: parseInt(provinceCode),
                    DistrictCode: parseInt(districtCode),
                    WardCode: wardCode ? parseInt(wardCode) : null,
                    StreetName: streetName,
                    AddressDetail: addressDetail,
                    Latitude: parseFloat(latitude),
                    Longitude: parseFloat(longitude),

                    LoaiTin: loaiTin,
                    ThoiGianTuan: thoiGianTuan,
                    NgayBatDau: ngayBatDau,

                    ImageUrls: imageUrls
                };

                // 3. Gửi dữ liệu về Server (Controller) để lưu vào DB
                const response = await fetch('/Agent/PostNews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    // Có thể chuyển hướng đến trang quản lý tin đăng của tôi
                    // window.location.href = '/Agent/MyPosts'; 
                } else {
                    alert('Lỗi: ' + data.message);
                }

            } catch (error) {
                console.error('Lỗi tổng thể:', error);
                alert('Đã xảy ra lỗi không mong muốn. Vui lòng kiểm tra console.');
            } finally {
                $(this).attr('disabled', false).text('Đăng tin'); // Bật lại nút
            }
        });
    </script>




}

