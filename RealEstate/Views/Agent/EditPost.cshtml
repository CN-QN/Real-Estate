@model RealEstate.Models.GetPropertyDetail_Result

@{
    ViewBag.Title = "EditPost";
    Layout = "~/Views/Shared/_LayoutAgent.cshtml";
}

<div class="edit-post-container">
    <h2>Chỉnh sửa Bài Đăng</h2>

    @using (Html.BeginForm("EditPost", "Agent", FormMethod.Post, new { enctype = "multipart/form-data" }))
    {
        @Html.HiddenFor(m => m.Id)

        <div class="form-section">
            <label for="Title">Tiêu đề:</label>
            @Html.TextBoxFor(m => m.Title, new { @class = "form-control", placeholder = "Nhập tiêu đề" })
        </div>

        <div class="form-section">
            <label for="Description">Mô tả:</label>
            @Html.TextAreaFor(m => m.Description, new { @class = "form-control", rows = 4, placeholder = "Nhập mô tả" })
        </div>

        <div class="form-section">
            <label>Giá:</label>
            <div class="price-inputs">
                @Html.TextBoxFor(m => m.PriceMin, new { @class = "form-control", placeholder = "Giá tối thiểu" })
                @Html.TextBoxFor(m => m.PriceMax, new { @class = "form-control", placeholder = "Giá tối đa" })
                @Html.TextBoxFor(m => m.PriceUnit, new { @class = "form-control", placeholder = "Đơn vị" })
            </div>
        </div>

        <div class="form-section">
            <label>Diện tích:</label>
            <div class="area-inputs">
                @Html.TextBoxFor(m => m.AreaMin, new { @class = "form-control", placeholder = "Diện tích tối thiểu" })
                @Html.TextBoxFor(m => m.AreaMax, new { @class = "form-control", placeholder = "Diện tích tối đa" })
                @Html.TextBoxFor(m => m.AreaUnit, new { @class = "form-control", placeholder = "Đơn vị" })
            </div>
        </div>

        <div class="form-section">
            <label for="Address_detail">Địa chỉ:</label>
            @Html.HiddenFor(m => m.Address_id)
            @Html.TextBoxFor(m => m.Address, new { @class = "form-control", placeholder = "Nhập địa chỉ" })
        </div>


        <div class="form-section">
            <label for="TypeId">Loại BĐS:</label>
            @Html.DropDownList("TypeId", (SelectList)ViewBag.Type, Model.NameType, new { @class = "form-control" })

        </div>



        <div class="form-section">
            <label>Gallery hiện tại:</label>
            <div class="property-images">
                @if (!string.IsNullOrEmpty(Model.ImageGallery))
                {
                    var images = Model.ImageGallery.Split(',');
                    foreach (var img in images)
                    {
                        <div class="image-wrapper position-relative" id="img-@img.Replace(".", "").Replace(",", "")">
                            <img src="~/Content/Uploads/@img" class="gallery-image" alt="Image" />
                            <button type="button"
                                    class="btn-delete-image"
                                    onclick="deleteImage(@Model.Id, '@img')">
                                ×
                            </button>
                        </div>
                    }
                }
            </div>

            <input type="file" name="GalleryFiles" multiple class="form-control" id="GalleryFiles" />

            <!-- 🆕 Vùng preview ảnh mới -->
            <div id="preview-container" class="property-images" style="margin-top: 10px;"></div>
        </div>


        <div class="action-buttons">
            <button type="submit" class="btn-save">Lưu</button>
            <a href="@Url.Action("Index", "Agent")" class="btn-cancel">Hủy</a>
        </div>
    }
</div>

<style>
    .edit-post-container {
        max-width: 900px;
        margin: 20px auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        font-family: Arial, sans-serif;
    }

        .edit-post-container h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #0275d8; /* xanh chỉnh sửa */
        }

    .form-section {
        margin-bottom: 15px;
    }

        .form-section label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
    }

    .price-inputs,
    .area-inputs {
        display: flex;
        gap: 10px;
    }

    .property-images {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
    }

        .property-images .main-image {
            width: 300px;
            height: 200px;
            object-fit: cover;
            border-radius: 6px;
        }

        .property-images .gallery-image {
            width: 100px;
            height: 70px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }

            .property-images .gallery-image:hover {
                transform: scale(1.1);
            }

    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
    }

    .btn-save {
        background-color: #0275d8;
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
    }

        .btn-save:hover {
            background-color: #025aa5;
        }

    .btn-cancel {
        background-color: #6c757d;
        color: white;
        text-decoration: none;
        padding: 10px 25px;
        border-radius: 6px;
        font-weight: bold;
        transition: background-color 0.3s;
    }

        .btn-cancel:hover {
            background-color: #5a6268;
        }

    .image-wrapper {
        position: relative;
        display: inline-block;
    }

    .btn-delete-image {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: red;
        color: white;
        border: none;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        cursor: pointer;
        font-weight: bold;
        line-height: 16px;
    }

        .btn-delete-image:hover {
            background-color: darkred;
        }
</style>
<script>
    function deleteImage(postId, imageName) {
        if (!confirm("Bạn có chắc chắn muốn xóa ảnh này?")) return;

        $.ajax({
            url: '/Agent/DeleteImage',
            type: 'POST',
            data: { id: postId, name: imageName  },
            success: function (res) {
                if (res.success) {
                    const safeId = imageName.replace(/\./g, "").replace(/,/g, "");
                    document.getElementById("img-" + safeId)?.remove();
                } else {
                    alert(res.message);
                }
            },
            error: function () {
                alert("Có lỗi xảy ra khi gửi yêu cầu xóa ảnh.");
            }
        });
    }

    // 🆕 Hiển thị preview khi chọn ảnh mới
    const fileInput = document.getElementById("GalleryFiles");
    const previewContainer = document.getElementById("preview-container");

    fileInput.addEventListener("change", function (e) {
        previewContainer.innerHTML = ""; // clear preview cũ
        const files = e.target.files;

        Array.from(files).forEach((file, index) => {
            const imgURL = URL.createObjectURL(file);
            const wrapper = document.createElement("div");
            wrapper.classList.add("image-wrapper", "position-relative");

            const img = document.createElement("img");
            img.src = imgURL;
            img.classList.add("gallery-image");
            img.alt = file.name;

            const delBtn = document.createElement("button");
            delBtn.innerText = "×";
            delBtn.classList.add("btn-delete-image");
            delBtn.onclick = () => {
                wrapper.remove();

                // 🧹 Xóa ảnh khỏi input nếu người dùng xóa preview
                const dt = new DataTransfer();
                Array.from(fileInput.files)
                    .filter(f => f !== file)
                    .forEach(f => dt.items.add(f));
                fileInput.files = dt.files;
            };

            wrapper.appendChild(img);
            wrapper.appendChild(delBtn);
            previewContainer.appendChild(wrapper);
        });
    });
</script>
